
- name: Build APK with Buildozer
  run: |
    # 1. ุญุฐู ูพูุดูโูุง ูุฏู
    rm -rf .name: Build Android APK
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install basic dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip python3-venv git wget zip unzip \
          openjdk-17-jdk

    - name: Install Buildozer
      run: |
        pip install buildozer cython==0.29.33

    - name: Setup Android licenses
      run: |
        mkdir -p ~/.android/licenses
        echo -e "8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e" > ~/.android/licenses/android-sdk-license

    - name: Build APK
      run: |
        # Clean previous builds
        rm -rf .buildozer bin 2>/dev/null || true
        
        # Let Buildozer handle everything
        buildozer android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-apk
        path: bin/*.apk
        retention-days: 7 2>/dev/null || true
    
    # 2. ุณุงุฎุช ุงููู ุจุฑุง ุฏุงูููุฏ ุงุจุฒุงุฑูุง (ุจุฏูู ุงูุชุธุงุฑ ูุงุณูุณ)
    echo "๐ง ูุฑุญูู ุงูู: ุฏุงูููุฏ ุงููู ุงุจุฒุงุฑูุง..."
    timeout 30 buildozer android debug 2>&1 | grep -v "License android" || true
    
    # 3. ุญุงูุง ฺฉู ุงุจุฒุงุฑูุง ุฏุงูููุฏ ุดุฏูุฏุ ูุงุณูุณ ุฑุง ุชุฃุฏ ูโฺฉูู
    echo "๐ ุชุฃุฏ ูุงุณูุณโูุง ุงูุฏุฑูุฏ..."
    cd ~/.buildozer/android/platform/android-sdk
    mkdir -p licenses
    echo -e "8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e\n24333f8a63b6825ea9c5514f83c2829b004d1fee\n84831b9409646a918e30573bab4c9c91346d8abd\n601085b94cd77f0b54ff86406957099ebe79c4d6" > licenses/android-sdk-license
    
    # 4. ุจุงุฒฺฏุดุช ุจู ุฏุงุฑฺฉุชูุฑ ูพุฑูฺู ู ุณุงุฎุช ููุง
    cd /home/runner/work/Breathing_app_1/Breathing_app_1
    echo "๐ ุดุฑูุน ุณุงุฎุช ููุง APK..."
    buildozer android debug
    
    # 5. ุงฺฏุฑ ุฎุทุง ุฏุงุดุชุ ฺฉ ุจุงุฑ ุฏฺฏุฑ ุชูุงุด ฺฉู
    if [ $? -ne 0 ]; then
      echo "โ๏ธ ุณุงุฎุช ุงูู ุดฺฉุณุช ุฎูุฑุฏุ ุชูุงุด ูุฌุฏุฏ..."
      buildozer android debug
    fi
