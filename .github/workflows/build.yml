name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip python3-venv git wget zip unzip \
          openjdk-17-jdk build-essential \
          python3-dev libffi-dev libssl-dev  # Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ÛŒ Cython

    - name: Install Python packages
      run: |
        # Ù†ØµØ¨ Cython Ø¨Ø§ pip - Ù‚Ø·Ø¹ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        pip install --upgrade pip setuptools wheel
        pip install cython==0.29.33
        pip install buildozer
        
        # ØªØ£ÛŒÛŒØ¯ Ù†ØµØ¨ Cython
        python -c "import cython; print('âœ… Cython Ù†ØµØ¨ Ø´Ø¯. Ù†Ø³Ø®Ù‡:', cython.__version__)"
        
        # ØªØ£ÛŒÛŒØ¯ Ù†ØµØ¨ Buildozer
        buildozer --version

    - name: Setup Android licenses
      run: |
        mkdir -p ~/.android/licenses
        echo -e "8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e" > ~/.android/licenses/android-sdk-license
        echo "âœ… Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù†Ø¯"

    - name: Build APK
      run: |
        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø³Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
        rm -rf .buildozer 2>/dev/null || true
        rm -rf bin 2>/dev/null || true
        
        echo "ğŸš€ Ø´Ø±ÙˆØ¹ Ø³Ø§Ø®Øª APK..."
        # Ø³Ø§Ø®Øª APK
        buildozer android debug
        
        # Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø§Ø´ØªØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†
        if [ $? -ne 0 ]; then
          echo "âš ï¸  Ø³Ø§Ø®Øª Ø§ÙˆÙ„ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯. ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯..."
          buildozer android debug
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: breathing-app-apk
        path: bin/*.apk
        retention-days: 7
        if-no-files-found: error
